name: Mirror to GitLab (Manual Force)

on:
  push:
    branches: [ "master", "main" ] # 包含了 master 和 main，防呆
  workflow_dispatch:

jobs:
  manual-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 必须拉取全部历史

      - name: Debug and Push
        env:
          # 把 Secret 映射成环境变量，避免直接拼接 URL 出错 
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GL_USER: "renleihaokun"
          TARGET_REPO: "gitlab.com/renleihaokun/renleihaokun-blog.git"
        run: |
          echo "------ 第一步：检查 Token 是否存在 ------"
          if [ -z "$GL_TOKEN" ]; then
            echo "❌ 严重错误：GitHub 根本没读到 GITLAB_TOKEN！"
            echo "请检查你的 Secret 是不是设在了 Environment 里而不是 Repository Secret 里？"
            exit 1
          else
            echo "✅ Token 读取成功 (长度: ${#GL_TOKEN})"
          fi

          echo "------ 第二步：配置 Git ------"
          # 这一步是为了防止某些特殊的 Token 字符破坏 URL 格式
          # 我们把 Token 写进 git 的 http header 缓存里，这是最稳的方式
          git config --global credential.helper store
          echo "https://oauth2:${GL_TOKEN}@gitlab.com" > ~/.git-credentials

          echo "------ 第三步：添加远程仓库 ------"
          # 注意：这里 URL 里不带密码了，依靠上面的 credentials 验证
          git remote add gitlab "https://${TARGET_REPO}"
          
          echo "------ 第四步：暴力推送 ------"
          # 强制推送到 gitlab 的 master 分支
          # 如果你的主分支是 main，请把下面的 master 改成 main
          git push gitlab HEAD:master --force
